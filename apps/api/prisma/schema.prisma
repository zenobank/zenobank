generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NetworkType {
  EVM
  SOLANA
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  password    String
  clerkUserId String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stores      Store[]
}

model Store {
  id        String    @id @default(uuid())
  name      String
  domain    String
  wallets   Wallet[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Payment   Payment[]
  apiKey    String    @unique @default(cuid())
  User      User?     @relation(fields: [userId], references: [id])
  userId    String?
}

model Wallet {
  id      String @id @default(uuid())
  address String

  networkId String
  network   Network @relation(fields: [networkId], references: [id])

  label     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payments Payment[] @relation("DepositWallet")

  activityWebhook   ActivityWebhook? @relation(fields: [activityWebhookId], references: [id])
  activityWebhookId String?
  Store             Store?           @relation(fields: [storeId], references: [id])
  storeId           String?

  @@unique([networkId, address])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  UNDER_PAYMENT
  COMPLETED
  EXPIRED
  CANCELLED
}

model Payment {
  id      String @id @default(cuid())
  orderId String

  title       String?
  description String?

  priceCurrency String
  priceAmount   String

  storeId String?
  store   Store?  @relation(fields: [storeId], references: [id])

  payAmount       String?
  payAmountFilled String  @default("0")

  webhookUrl        String?
  successUrl        String?
  verificationToken String?
  paidAt            DateTime?

  expiredAt DateTime?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  status    PaymentStatus @default(PENDING)

  payCurrencyId String?
  payCurrency   Token?  @relation(fields: [payCurrencyId], references: [id])

  confirmationAttempts Int @default(0)

  networkId String?
  network   Network? @relation(fields: [networkId], references: [id])

  transactionHash String?

  depositWalletId String?
  depositWallet   Wallet? @relation(name: "DepositWallet", fields: [depositWalletId], references: [id])
}

enum TokenStandard {
  NATIVE
  ERC20
  BEP20
  TRC20
  SPL
}

model Network {
  id          String      @id
  networkType NetworkType
  name        String      @unique
  displayName String
  isTestnet   Boolean
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  minBlockConfirmations   Int @default(3)
  maxConfirmationAttempts Int @default(100)
  confirmationRetryDelay  Int @default(1000) // in ms

  tokens           Token[]
  wallets          Wallet[]
  Payment          Payment[]
  activityWebhooks ActivityWebhook[]
}

model Token {
  id               String @id
  canonicalTokenId String

  standard     TokenStandard
  address      String
  decimals     Int
  symbol       String
  isDeprecated Boolean       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  network   Network  @relation(fields: [networkId], references: [id])
  networkId String

  Payment Payment[]

  @@unique([networkId, address])
  @@index([canonicalTokenId])
  @@index([networkId, symbol])
}

enum AddressBindingType {
  TOPUP
  SINGLE_USE_PAYMENT
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

// model TransactionTransfer {
//   id             String @id @default(uuid())
//   transactionId  String
//   transaction    Transaction @relation(fields: [transactionId], references: [id])

//   fromAddress    String
//   toAddress      String
//   tokenId        String?     // null si es nativo
//   amount         Decimal
//   amountFiat     Decimal?    // snapshot opcional

//   logIndex       Int?        // para EVM logs
//   traceId        String?     // para internal txs

//   createdAt      DateTime @default(now())

//   @@index([transactionId])
//   @@index([fromAddress])
//   @@index([toAddress])
// }

enum WebhookProvider {
  ALCHEMY
}

model ActivityWebhook {
  id        String @id @default(uuid())
  webhookId String @unique

  providerId WebhookProvider

  networkId String
  network   Network @relation(fields: [networkId], references: [id])

  currentSize Int @default(0)
  maxSize     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallets Wallet[]
}
